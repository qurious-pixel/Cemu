name: Build Cemu

on:
  workflow_dispatch:
  push:

jobs:
  FreeBSD_Build:
    name: Cemu FreeBSD 
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      CCACHE_DIR: ${{ github.workspace }}/ccache
    steps:
      - name: Checkout repository
        uses: actions/checkout@main
        with:
          repository: kreinholz/Cemu-upstream # cemu-project/Cemu
          ref: main
          submodules: recursive
          fetch-depth: 0

      - name: Restore Build Ccache
        uses: actions/cache/restore@main
        id: restore-build-ccache
        with:
          path: ${{ env.CCACHE_DIR }}
          key: FreeBSD-ccache-${{github.run_id}}
          restore-keys: FreeBSD-ccache-

      - name: FreeBSD build
        id: root
        uses: vmactions/freebsd-vm@v1
        with:
          envs: 'CCACHE_DIR'
          usesh: true
          run: |
            sed -i '' 's/quarterly/latest/' /etc/pkg/FreeBSD.conf
            export ASSUME_ALWAYS_YES=true
            pkg info # debug
            pkg install llvm16
            pkg install git ccache cmake ninja ffmpeg
            pkg install pkgconf alsa-lib pulseaudio sdl3 evdev-proto vulkan-headers vulkan-loader opencv
            
            cmake -B build -G Ninja
            cmake --build build

      - name: Save Build Ccache
        if: github.ref == 'refs/heads/master'
        uses: actions/cache/save@main
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ steps.restore-build-ccache.outputs.cache-primary-key }}

