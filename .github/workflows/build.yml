name: Build Cemu

on:
  workflow_call:
  push:

jobs:
  build-fedora:
    runs-on: ubuntu-latest
    container:
      image: rpcs3/rpcs3-ci-jammy-aarch64:1.6
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: "recursive"
        fetch-depth: 0

    - name: Setup release mode parameters
      run: |
        echo "BUILD_MODE=release" >> $GITHUB_ENV
        echo "BUILD_FLAGS=" >> $GITHUB_ENV
        echo "Build mode is release"
        
    - name: "Fetch full history for vcpkg submodule"
      run: |
        cd dependencies/vcpkg
        git remote update
        git pull origin master
        
    - name: "Bootstrap vcpkg"
      run: |
        bash ./dependencies/vcpkg/bootstrap-vcpkg.sh
        
    - name: "cmake"
      run: |
        cmake -S . -B build ${{ env.BUILD_FLAGS }} -DCMAKE_BUILD_TYPE=${{ env.BUILD_MODE }} -DCMAKE_C_COMPILER=/usr/bin/gcc -DCMAKE_CXX_COMPILER=/usr/bin/g++ -G Ninja -DCMAKE_MAKE_PROGRAM=/usr/bin/ninja -DCMAKE_AR=/usr/bin/ar
        
    - name: "Build Cemu"
      run: |
        cmake --build build
        
    - name: Prepare artifact
      run: mv bin/Cemu_release bin/Cemu
              
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: cemu-bin-fedora-x64
        path: ./bin/Cemu

   # - name: Docker setup and build
   #   run: |
   #       chmod +x linux_arm64_build.sh
   #       docker pull --quiet rpcs3/rpcs3-ci-jammy-aarch64:1.6
   #       docker run \
   #         -v $PWD:/cemu \
   #         --env-file .ci/docker.env \
   #         rpcs3/rpcs3-ci-jammy-aarch64:1.6 \
   #         ./linux_arm64_build.sh
         
   # - name: Upload artifact
   #   uses: actions/upload-artifact@v4
   #   with:
   #     name: cemu-bin-linux-x64
   #     path: ./bin/Cemu

  #build-appimage:
  #  runs-on: ubuntu-22.04
  #  needs: build-ubuntu
  #  steps:
  #  - name: Checkout Upstream Repo
  #    uses: actions/checkout@v4

  #  - uses: actions/download-artifact@v4
  #    with:
  #      name: cemu-bin-linux-x64
  #      path: bin

  # - name: "Install system dependencies"
  #    run: |
  #      sudo apt update -qq
  #      sudo apt install -y clang-15 cmake freeglut3-dev libgcrypt20-dev libglm-dev libgtk-3-dev libpulse-dev libsecret-1-dev libsystemd-dev nasm ninja-build appstream libbluetooth-dev

  # - name: "Build AppImage"
  #  run: |
  #      export LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"
  #      export DEPLOY_GTK_VERSION=3
  #      dist/linux/appimage.sh

  # - name: Upload artifact
  #   uses: actions/upload-artifact@v4
  #   with:
  #     name: cemu-appimage-x64
  #     path: artifacts


